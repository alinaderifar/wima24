; ==============================================================================
; LaraClassifier PHP-FPM Configuration for Production
; ==============================================================================
; Location: php-fpm.conf (repository root)
;
; This PHP-FPM configuration is optimized for Laravel production deployment.
; It will be copied to /usr/local/etc/php-fpm.d/zz-laraclassifier.conf
;
; ==============================================================================

; ------------------------------------------------------------------------------
; Global Settings
; ------------------------------------------------------------------------------

[global]
; Log level: alert, error, warning, notice, debug
log_level = notice

; Emergency restart threshold
emergency_restart_threshold = 10
emergency_restart_interval = 1m

; Process control timeout
process_control_timeout = 10s

; Daemonize (run in background)
daemonize = no

; ------------------------------------------------------------------------------
; Pool Configuration: www
; ------------------------------------------------------------------------------

[www]

; Pool user and group
user = www-data
group = www-data

; Listen on port 9000
listen = 9000

; Listen permissions
listen.owner = www-data
listen.group = www-data
listen.mode = 0660

; Allowed clients (any in Docker network)
listen.allowed_clients = any

; Process Manager Settings
pm = dynamic

; Maximum number of child processes
pm.max_children = 50

; Number of child processes created on startup
pm.start_servers = 5

; Minimum number of idle processes
pm.min_spare_servers = 5

; Maximum number of idle processes
pm.max_spare_servers = 35

; Maximum requests per process (prevents memory leaks)
pm.max_requests = 500

; Process manager status path
pm.status_path = /php-fpm-status

; Ping path for health checks
ping.path = /php-fpm-ping
ping.response = pong

; Request slowlog
slowlog = /var/www/storage/logs/php-fpm-slow.log
request_slowlog_timeout = 30s
request_terminate_timeout = 120s

; Catch output from workers
catch_workers_output = yes
decorate_workers_output = no

; Clear environment variables
clear_env = no

; Security: Limit extensions
security.limit_extensions = .php

; PHP settings for this pool
php_admin_value[error_log] = /var/www/storage/logs/php-fpm-error.log
php_admin_flag[log_errors] = on

; Memory limit for workers
php_admin_value[memory_limit] = 256M

; Maximum execution time
php_admin_value[max_execution_time] = 120

; Upload settings
php_admin_value[upload_max_filesize] = 25M
php_admin_value[post_max_size] = 25M

; ------------------------------------------------------------------------------
; Environment Variables
; ------------------------------------------------------------------------------

; Pass environment variables to PHP
env[APP_ENV] = $APP_ENV
env[APP_DEBUG] = $APP_DEBUG
env[APP_KEY] = $APP_KEY
env[APP_URL] = $APP_URL
env[DB_HOST] = $DB_HOST
env[DB_PORT] = $DB_PORT
env[DB_DATABASE] = $DB_DATABASE
env[DB_USERNAME] = $DB_USERNAME
env[DB_PASSWORD] = $DB_PASSWORD
env[REDIS_HOST] = $REDIS_HOST
env[REDIS_PORT] = $REDIS_PORT
env[REDIS_PASSWORD] = $REDIS_PASSWORD

; ==============================================================================
; Notes
; ==============================================================================
;
; For high-traffic sites, consider:
;   - pm = static
;   - pm.max_children = 100+
;   - Increase memory_limit
;
; For development:
;   - log_level = debug
;   - pm.start_servers = 2
;   - pm.min_spare_servers = 1
;
; ==============================================================================
